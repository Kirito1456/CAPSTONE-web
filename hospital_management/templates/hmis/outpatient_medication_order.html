{%load static%}
<title>{% block title %}Patient Data{% endblock %}</title>

{% block styles%} 
<!-- <link rel="stylesheet" href="{% static 'css/patient_medication_style.css' %}"> -->
<link rel="stylesheet" href="{% static 'css/view_treatment_plan.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-***" crossorigin="anonymous" />
<style>
    body{
        font-family: 'Arial', sans-serif;
    }
    #medication-table{
        width: 90%;
    
        border-bottom: #334A7C solid 1px;
    }
    
    .row span {
        display: inline-block;
        margin-right: 10px; /* Add margin to separate cells */
    }
    
    th{
        text-align: center;
        font-weight: bold;
    
        font-size: 14px;
    
        padding: 5px;
    
        background-color: #334A7C;
        color: #fff;   
    }

    .buttons_info {
        padding: 5px;
        margin: 5px; 
        border: none; 
        border-radius: 4px; 
        background-color: #ADB8CE; 
        color: black;
        cursor: pointer; 
        margin-right:10px;
    }


</style>
{% endblock styles%}

{% block content %}
<div class = "whole-screen">
    <div id = "side-menu" style="background-color: #334a7c;">
        <div id = "all-info">
            <div id = "user-info"> 
                <div id = "image">
                    <img src="{% static 'logo-color.png' %}" id = "display-photo">
                </div>
                <div id="information">
                    {% for doctor_id, doctor_data in doctors.items %}
                        {% if doctor_data.uid == uid %}
                            <div id="name" style="font-size: 22px;"> {{ doctor_data.fname }} {{ doctor_data.lname }}</div>
                            <div id="role" style="font-size: 16px;"> {{ doctor_data.specialization}}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div id="menu"> 
                <div id="a1"><i class="fas fa-tachometer-alt"></i> <a href="{% url 'DoctorDashboard' %}">Dashboard</a></div>
                <div id="a2"> <i class="far fa-calendar-alt"></i> <a href="{% url 'AppointmentUpcoming' %}">Appointments</a></div>
                <div id="a3" style="font-weight: bold;"><i class="fas fa-user"></i> <a href="{% url 'patient_data_doctor_view' %}">Patients</a></div>
                
                <div id="a4"><i class="fas fa-sign-out-alt"></i> <a href="{% url 'logout' %}"> Logout</a></div>

            </div>
        </div>
    </div>
    </div>
    <div id = "other-information">
        <div id = "title">
            <div id = "left">
                <button id="backButton">Back</button>
            </div>
        </div>

        <div id = "treatment-plan">

            {% for patients_id, patients_data in patients.items %}
                {% if patients_data.uid == patient_uid %}
                    <div id = "patient-information">
                        <div id = "first">
                            <div id = "fname-label">Name of Patient</div>
                            <div id="fname">{{patients_data.fname}} {{patients_data.lname}}</div>
                        </div>
                        <div id = "gender">
                            <div id = "gender-label">Gender</div>
                            <div id = "gender-view">{{ patients_data.gender }}</div>
                        </div>
                        <div id = "bday">
                            <div id = "bday-label">Date of Birth</div>
                            <div id = "birthday-view">{{ patients_data.bday }}</div>
                        </div>
                        <div id = "age">
                            <div id = "age-label">Age</div>
                            <div id = "age-view"></div>
                        </div>   
                        
                        <div id="today">
                            <div id="today-label">Date of Prescription</div>
                        
                            <div id="today-view">{{latest_date}}</div>
                 
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
                <hr>
            <form id="medication-form" method="post" action="{% url 'save_prescriptions' %}?chosenPatient={{patient_uid}}">
                {% csrf_token %}
                    <div id="medications-container">
                        <div style="margin-top: 20px; margin-bottom: 10px; font-size: 15px;" id="head">Add Medicine Here</div>
                        <div id="medication-list-container">
                            <div id="table-header" style="background-color: #334A7C; display: flex; color: white; padding: 10px;">
                                <div style="flex: 1; text-align: center;">Days</div>
                                <div style="flex: 1; text-align: center;">Medicine Name</div>
                                <div style="flex: 1; text-align: center;">Dosage</div>
                                <div style="flex: 1; text-align: center;">Route</div>
                                <div style="flex: 1; text-align: center;">Frequency</div>
                                <div style="flex: 1; text-align: center;">Additional Remarks</div>
                            </div>
                            <div id="table-body">
                                <div style="flex: 1; text-align: center;"><input type="number" name="days" id="daysInput" placeholder="Enter number of days"></div>
                                <div style="flex: 1; text-align: center;">
                                    <input type="text" name="medicine_name" id="medicine_name_input" placeholder="Enter Medicine Name" list="medicine_name_suggestions">
                                    <datalist id="medicine_name_suggestions">
                                        {% for medicine in medicines_list %}
                                            <option value="{{ medicine }}">{{ medicine }}</option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                
                                <div style="flex: 1; text-align: center;">
                                    <select class="dosage-input" name="dosage" id="dosage_input">
                                        <option value="" selected disabled>Select Dosage</option>
                                    </select>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <input type="text" name="route" id="route_input" placeholder="Enter Route Name">
                                </div>
                                <div>
                                    <div style="flex: 1; text-align: center;">
                                        <div style="text-align: center;">
                                            <input type="checkbox" name="times-daily[]" id="morning-checkbox" value="Morning">
                                            <label for="morning-checkbox">Morning</label>
                                        </div>
                                        <div style="text-align: center;">
                                            <input type="checkbox" name="times-daily[]" id="afternoon-checkbox" value="Afternoon">
                                            <label for="afternoon-checkbox">Afternoon</label>
                                        </div>
                                        <div style="text-align: center;">
                                            <input type="checkbox" name="times-daily[]" id="evening-checkbox" value="Evening">
                                            <label for="evening-checkbox">Evening</label>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1; text-align: center;"><input type="text" class="remarks-input" placeholder="Additional Remarks" name="additionalremarks" id="remarksInput"></div>
                            </div>
                        </div>
                        
                        <button class="buttons_info" id="add-medication-button" type="button">Add</button>
                    </div>
                
                <hr>
                
                <div style="margin-top: 20px; margin-bottom: 10px; margin-left: 10px; font-size: 15px;" id="head">Medicine List</div>
                <div id="medication_cart">
                    
                    <div id="medicineList" name="medicineList" style="align-items: center;"></div>
                    <input type="hidden" id="hiddenFieldsContainer" name="hiddenFieldsContainer">
                    
                    <button class="buttons_info" name="submitorders" style="margin-left: 16px;" action="{% url 'save_prescriptions' %}?chosenPatient={{patient_uid}}">Submit</button>
                    
                </div>
            </form>
                <button class="buttons_info" onclick="openModal7()" style="margin-left: 16px;">Upload Image</button>
        </div>
</div>


<div id="myModal" class="modal" style="background-color: rgba(128, 128, 128, 0.5);">
    <div class="modal-content" style="background-color: white;">
        <span class="close">&times;</span>
        <h2>Uploading Photo</h2>
        <div id="uploading-header">Upload Handwritten Image</div>
        <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'perform_ocr' %}?chosenPatient={{patient_uid}}">
            {% csrf_token %}
          
            <div id="upload">
                <input type="file" id="file-input" name="image" style="display: none;" onchange="displayFileName(this)">
                <label for="file-input" id="file-label"><i class="fas fa-plus"></i>&nbsp; Choose Photo</label>
                <span id="selected-file"></span>
                <button id="remove-button" type="button" onclick="removeFile()" style="display: none;">Remove</button>
                {% for patients_id, patients_data in patients.items %}
                {% if patients_data.uid == patient_uid %}
                <button id="upload-button" type="submit" style="display: none;" >Upload Photo</button>
                {% endif %}
                {% endfor %}
            </div>
        </form>   
    </div>
</div>

<script src="{% static 'js/create-medication.js' %}"></script>
{% comment %} <script src="{% static 'js/ocr12.js' %}"></script> {% endcomment %}
<script>
    function displayFileName(input) {
        var fileName = input.files[0].name;
        document.getElementById('selected-file').innerText = 'Selected File: ' + fileName;
        document.getElementById('remove-button').style.display = 'inline-block';
        document.getElementById('upload-button').style.display = 'inline-block';
    }

    function removeFile() {
        document.getElementById('file-input').value = '';
        document.getElementById('selected-file').innerText = '';
        document.getElementById('remove-button').style.display = 'none';
        document.getElementById('upload-button').style.display = 'none';
    }
    document.getElementById("add-medication-button").addEventListener("click", function() {
        // Retrieve input values
        var days = document.getElementById("daysInput").value;
        var medicineName = document.getElementById("medicine_name_input").value;
        var dosage = document.getElementById("dosage_input").value;
        var route = document.getElementById("route_input").value;
        var remarks = document.getElementById("remarksInput").value;
    
        
    
        // Check if medicine with the same name already exists
        var existingMedicines = document.querySelectorAll('.medicine-name');
        for (var i = 0; i < existingMedicines.length; i++) {
            if (existingMedicines[i].innerText === medicineName) {
                alert("Medicine with the same name already exists.");
                return;
            }
        }
    
        // Create a new row container
        var newRow = document.createElement("div");
        newRow.classList.add("row");
        newRow.style.display = "flex";
        newRow.style.padding = "10px";
        newRow.style.alignItems = "center";
    
        // Create cells for each value
        var cells = [
            document.createElement("div"),
            document.createElement("div"),
            document.createElement("div"),
            document.createElement("div"),
            document.createElement("div"),
            document.createElement("div"),
            document.createElement("div") // For the Remove button
        ];
    
        // Set icon content
        var icon = document.createElement("i");
        icon.classList.add("fas", "fa-medkit"); 
        icon.style.marginRight = "5px";
        cells[0].appendChild(icon);
    
        // Set cell content with numbering
        cells[1].classList.add("medicine-name"); // Add class for medicine name
        cells[1].innerHTML = "<span>" + medicineName + " (" + dosage + ")</span>";
        cells[2].innerHTML = "<span>Sig. Take for <strong>" + days + "</strong> days during ";
    
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    
        // Array to store checked times
        var checkedTimes = [];
    
        // Loop through checked checkboxes and add their values to the array
        checkboxes.forEach(function(checkbox) {
            checkedTimes.push(checkbox.value);
        });
    
        // Combine checked times into one string separated by commas
        var checkedTimesString = checkedTimes.join(", ");
    
        // Append checked times string to the cell
        cells[3].innerText = checkedTimesString;
        cells[3].style.marginRight = "5px";
    
        // Append cells to the new row
        cells.forEach(function(cell) {
            newRow.appendChild(cell);
        });
    
        cells[4].innerHTML = "<span> through <strong>" + route + "</strong>. " + remarks + "</span>";
    
        // Append new row container to the medicine list
        document.getElementById("medicineList").appendChild(newRow);
    
        var hiddenFieldsContainer = document.getElementById("hiddenFieldsContainer");
    
        var hiddenFields = [
            { name: "medicine_name[]", value: medicineName },
            { name: "dosage[]", value: dosage },
            { name: "days[]", value: days },
            { name: "route[]", value: route },
            { name: "remarks[]", value: remarks },
            { name: "times[]", value: checkedTimesString }
        ];
    
        var removeButton = document.createElement("button");
        removeButton.textContent = "Remove";
        removeButton.classList.add("remove-button");
        cells[6].appendChild(removeButton);
    
        removeButton.addEventListener("click", function() {
            newRow.remove(); // Remove the row from the DOM
    
           
        });
    
        hiddenFields.forEach(function(field) {
            var hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = field.name;
            hiddenInput.value = field.value;
            hiddenFieldsContainer.appendChild(hiddenInput);
        });
    });
    
    

    function openModal7() {
        var modal = document.getElementById('myModal');
        modal.style.display = "block";
    }

    // Function to close the modal
    function closeModal() {
        var modal = document.getElementById('myModal');
        modal.style.display = "none";
    }
    // Retrieve pharmacy_lists from the template
    var pharmacyLists = JSON.parse('{{ pharmacy_lists|escapejs }}');
    console.log(pharmacyLists);  // Print pharmacy_lists to the console

    // Add your additional JavaScript code here
    const medicineNameInput = document.getElementById('medicine_name_input');
    const dosageInput = document.getElementById('dosage_input');
    const routeInput = document.getElementById('route_input');

    medicineNameInput.addEventListener('input', populateDosageDropdown);

    dosageInput.addEventListener('change', changeRouteDropdown);

    function populateDosageDropdown() {
        const selectedMedicine = medicineNameInput.value.trim();
        dosageInput.innerHTML = '<option value="" selected disabled>Select Dosage</option>'; // Reset dosage dropdown
        
        // Populate dosage dropdown based on selected medicine
        pharmacyLists.forEach(function(pharmacy) {
            if (pharmacy.Drug.trim() === selectedMedicine) { // Ensure consistent comparison
                const option = document.createElement('option');
                option.text = pharmacy.Strength;
                option.value = pharmacy.Strength;
                dosageInput.appendChild(option);
            }
        });

        // Trigger the change event on dosage dropdown to update the route dropdown
        dosageInput.dispatchEvent(new Event('change'));
    }

    function changeRouteDropdown() {
        const selectedStrength = dosageInput.value.trim();
        
        // Change route dropdown based on selected strength
        pharmacyLists.forEach(function(pharmacy) {
            if (pharmacy.Strength.trim() === selectedStrength) { // Ensure consistent comparison
                routeInput.value = pharmacy.Route;
            }
        });
    }
    document.addEventListener("DOMContentLoaded", function() {
        var birthdayString = document.getElementById("birthday-view").innerText;
        var birthday = new Date(birthdayString);
        var today = new Date();
        var ageYear = today.getFullYear() - birthday.getFullYear();
        var ageMonth = today.getMonth() - birthday.getMonth();
        const backButton = document.getElementById('backButton');

        // Adjust age months if negative
        if (ageMonth < 0 || (ageMonth === 0 && today.getDate() < birthday.getDate())) {
            ageYear--;
            ageMonth += 12;
        }

        document.getElementById("age-view").innerText = ageYear + " years and " + ageMonth + " months";

        backButton.addEventListener('click', function() {
            window.history.back();
        });

        document.getElementById("select-all-checkbox").addEventListener("change", function() {
            selectAllCheckboxes();
        });
    
        document.getElementById('submit-medication-button').addEventListener('click', function () {
            alert('Successfully Added a Medication Order/Prescription!');
        });
        
    });
</script>

{% endblock %}